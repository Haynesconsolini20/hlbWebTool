
<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<style>
#plotHolder {
  float: right;
}

#inputs {
  float:left;
}
* {box-sizing:border-box}

/* Slideshow container */
.slideshow-container {
  max-width: 1000px;
  position: relative;
  margin: auto;
}

/* Hide the images by default */
.mySlides {
  display: none;
}

/* Next & previous buttons */
.prev, .next {
  cursor: pointer;
  position: absolute;
  top: 70%;
  width: auto;
  margin-top: -22px;
  padding: 8px;
  color: black;
  font-weight: bold;
  font-size: 18px;
  transition: 0.6s ease;
  border-radius: 0 3px 3px 0;
  user-select: none;
}

/* Position the "next button" to the right */
.next {
  right: 0;
  border-radius: 3px 0 0 3px;
}

/* On hover, add a black background color with a little bit see-through */
.prev:hover, .next:hover {
  background-color: rgba(255, 168, 29, 0.322);
}

/* Caption text */
.text {
  color: #f2f2f2;
  font-size: 15px;
  padding: 8px 12px;
  position: absolute;
  bottom: 8px;
  width: 100%;
  text-align: center;
}

/* Number text (1/3 etc) */
.numbertext {
  color: #f2f2f2;
  font-size: 12px;
  padding: 8px 12px;
  position: absolute;
  top: 0;
}

/* The dots/bullets/indicators */
.dot {
  cursor: pointer;
  height: 15px;
  width: 15px;
  margin: 0 2px;
  background-color: #bbb;
  border-radius: 50%;
  display: inline-block;
  transition: background-color 0.6s ease;
}

.active, .dot:hover {
  background-color: #717171;
}

/* Fading animation */
.fade {
  -webkit-animation-name: fade;
  -webkit-animation-duration: 1.5s;
  animation-name: fade;
  animation-duration: 1.5s;
}
.dotHolder {
  position: absolute;
  bottom: 25%;
  text-align: center;
  left: 75%;

}

@-webkit-keyframes fade {
  from {opacity: .4}
  to {opacity: 1}
}

@keyframes fade {
  from {opacity: .4}
  to {opacity: 1}
}
</style>

<!-- Create a div where the graph will take place -->
<h1>HLB Grower Web Tool</h1>
<p>
This is an unfinished, unstyled prototype of the HLB grower web tool. 
To use the tool, customize the options on the left and observe the output graphs on the right.
To cycle through all three graphs, use the left and right arrows located on the edges of the graphs.
</p>
<div id="inputs">
  <label>Length of Simulation in Years</label>
  <br>
  <input type="number" id="projectionLength" min=1 max=40 value=5 />
  <br><br>
  <label>How many months until HLB arrives in your grove</label>
  <br>
  <input type="number" id="monthsToStart" min=0 max=480>
  <br><br>
  <label>% of Neighbors engaging in coordinated spraying</label>
  <br>
  <input type="range" min="0" max="100" value="50" class="slider" id="alpha">
  <br><br>
  <label>Cost of Spray per acre</label>
  <br>
  <input type="number" id="sprayCost" value=100>
  <br><br>
  <label>Number of Acres</label>
  <br>
  <input type="number" id="numAcres" value=55>
  <br><br>
  <label>Average Annual Yield (in cartons)</label>
  <br>
  <input type="number" id="annualYield" value="1000">
  <br><br>
  <label>Average Return per Carton (price of carton)</label>
  <br>
  <input type="number" id="unitPrice" value="14">

</div>
<div id="plotHolder">
  <div id="hlbSpread" class="mySlides fade"></div>
  <div id="yield" class="mySlides fade"></div>
  <div id="returns" class="mySlides fade"></div>
  <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
  <a class="next" onclick="plusSlides(1)">&#10095;</a>
  <div class="dotHolder">
    <span class="dot" onclick="currentSlide(1)"></span>
    <span class="dot" onclick="currentSlide(2)"></span>
    <span class="dot" onclick="currentSlide(3)"></span>
  </div>
</div>

    
<script>
  //D3 and Plotting
  function noaction(x,alpha,startingMonth) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    var allSpray = 2 * scaledX;
    var noneSpray = 3 * scaledX;
    var difference = allSpray - noneSpray;
    return noneSpray + (scaledAlpha * difference);
  }

  function individualspray(x,alpha,startingMonth) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    var allSpray = scaledX;
    var noneSpray = 2 * scaledX;
    var difference = allSpray - noneSpray;
    return noneSpray + (scaledAlpha * difference);
  }

  function groupspray(x,alpha,startingMonth) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    var allSpray = 0.5 * scaledX;
    var noneSpray = scaledX;
    var difference = allSpray - noneSpray;
    return noneSpray + (scaledAlpha * difference);  }

  function infectedYield(severity) {
    return Math.exp(-1.85 * severity);
  }
  function plotHLBSpread() {

     // set the dimensions and margins of the graph
  var margin = {top: 50, right: 30, bottom: 30, left: 60},
      width = 660 - margin.left - margin.right,
      padding = 60,
      height = 400 - margin.top - margin.bottom;
  //Remove any previous graphics
  d3.select("#hlbSpread").html("")
  // append the svg object to the body of the page
  var svg = d3.select("#hlbSpread")
    .append("svg")
      .attr("width", width + margin.left + margin.right + padding)
      .attr("height", height + margin.top + margin.bottom + padding + padding)
      .attr("id", "hlbSpread_svg")
      .attr("viewBox", "0 0 " + width + " " + height)
      .attr("preserveAspectRatio", "xMidYMid meet")
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  
  var values = [];
  var startingMonth = d3.select("#monthsToStart").property("value");
  var numYears = d3.select("#projectionLength").property("value");
  var projectionLength = numYears * 365;
  var alpha = d3.select("#alpha").property("value");
  for (let x=1; x <= projectionLength; x++) {
    values.push({"x": x, "y": noaction(x,alpha, startingMonth),"strategy": "No Action" });
    values.push({"x": x, "y": individualspray(x,alpha,startingMonth), "strategy": "Individual Spray" });
    values.push({"x": x, "y": groupspray(x,alpha,startingMonth), "strategy": "Coordinated Spray" });
  }

  //Group data
  var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
  //X-axis
  var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding])
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(5));
  //X-axis label
  svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-padding)
    .attr("y", height + 40)
    .text("Days since today");

  // Add Y axis
  var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height, 0 ]);
  svg.append("g")
    .call(d3.axisLeft(y));
  // Add Y-axis label
  svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", -50)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("% of Grove infected with HLB");

  svg.append("text")
        .attr("x", ( (width - padding) / 2))             
        .attr("y", 0 - (margin.top / 2))
        .attr("class", "title")
        .attr("text-anchor", "middle")  
        .style("font-size", "20px") 
        .text("Spread of HLB in Your Grove Over Next " + numYears + " Years");
  // color palette
  var res = sumstat.map(function(d){ return d.key }) // list of group names
  var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

  // Draw the line
  svg.selectAll(".line")
      .data(sumstat)
      .enter()
      .append("path")
        .attr("fill", "none")
        .attr("stroke", function(d){ return color(d.key) })
        .attr("stroke-width", 1.5)
        .attr("d", function(d){
          return d3.line()
            .x(function(d) { return x(d.x); })
            .y(function(d) { return y(+d.y); })
            (d.values)
        })
  svg.append("text")
		.attr("transform", "translate(" + ( (width - padding) +3) + "," + y(noaction(projectionLength, alpha, startingMonth)) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "red")
		.text("No Action");

	svg.append("text")
		.attr("transform", "translate(" + (width-padding+3) + "," + y(individualspray(projectionLength, alpha, startingMonth)) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "steelblue")
		.text("Individual Spraying");
  
  svg.append("text")
		.attr("transform", "translate(" + (width-padding+3) + "," + y(groupspray(projectionLength, alpha, startingMonth)) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "#4daf4a")
		.text("Coordinated Spraying");

  }
  
  function plotYield() {
    // set the dimensions and margins of the graph
    var margin = {top: 50, right: 30, bottom: 30, left: 60},
    width = 660 - margin.left - margin.right,
    padding = 60,
    height = 400 - margin.top - margin.bottom;
    //Remove any previous graphics
    d3.select("#yield").html("")
    // append the svg object to the body of the page
    var svg = d3.select("#yield")
    .append("svg")
    .attr("width", width + margin.left + margin.right + padding)
    .attr("height", height + margin.top + margin.bottom + padding + padding)
    .attr("id", "yield_svg")
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

    var values = [];
    var startingMonth = d3.select("#monthsToStart").property("value");
    var numYears = d3.select("#projectionLength").property("value");
    var projectionLength = numYears * 365;
    var alpha = d3.select("#alpha").property("value");
    for (let x=1; x <= projectionLength; x++) {
      values.push({"x": x, "y": infectedYield(noaction(x,alpha, startingMonth)),"strategy": "No Action" });
      values.push({"x": x, "y": infectedYield(individualspray(x,alpha,startingMonth)), "strategy": "Individual Spray" });
      values.push({"x": x, "y": infectedYield(groupspray(x,alpha,startingMonth)), "strategy": "Coordinated Spray" });
    }

    //Group data
    var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
    //X-axis
    var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding])
    svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(5));
    //X-axis label
    svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-padding)
    .attr("y", height + 40)
    .text("Days since today");

    // Add Y axis
    var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height, 0 ]);
    svg.append("g")
    .call(d3.axisLeft(y));
    // Add Y-axis label
    svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", -50)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("% of Regular Yield Level");

    svg.append("text")
      .attr("x", ( (width - padding) / 2))             
      .attr("y", 0 - (margin.top / 2))
      .attr("class", "title")
      .attr("text-anchor", "middle")  
      .style("font-size", "20px") 
      .text("Average Yield in Your Grove Over Next " + numYears + " Years");
    // color palette
    var res = sumstat.map(function(d){ return d.key }) // list of group names
    var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

    // Draw the line
    svg.selectAll(".line")
    .data(sumstat)
    .enter()
    .append("path")
      .attr("fill", "none")
      .attr("stroke", function(d){ return color(d.key) })
      .attr("stroke-width", 1.5)
      .attr("d", function(d){
        return d3.line()
          .x(function(d) { return x(d.x); })
          .y(function(d) { return y(+d.y); })
          (d.values)
      })
    svg.append("text")
    .attr("transform", "translate(" + ( (width - padding) +3) + "," + y(infectedYield(noaction(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "red")
    .text("No Action");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(infectedYield(individualspray(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "steelblue")
    .text("Individual Spraying");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(infectedYield(groupspray(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "#4daf4a")
    .text("Coordinated Spraying");

  }

  function returnsPlot() {
    // set the dimensions and margins of the graph
    var margin = {top: 50, right: 30, bottom: 30, left: 60},
    width = 660 - margin.left - margin.right,
    padding = 60,
    height = 400 - margin.top - margin.bottom;
    //Remove any previous graphics
    d3.select("#returns").html("")
    // append the svg object to the body of the page
    var svg = d3.select("#returns")
    .append("svg")
    .attr("width", width + margin.left + margin.right + padding)
    .attr("height", height + margin.top + margin.bottom + padding + padding)
    .attr("id", "returns_svg")
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

    var values = [];
    var startingMonth = d3.select("#monthsToStart").property("value");
    var numYears = d3.select("#projectionLength").property("value");
    let alpha = d3.select("#alpha").property("value");
    let sprayCost = d3.select("#sprayCost").property("value");
    let numAcres = d3.select("#numAcres").property("value");
    let annualYield = d3.select("#annualYield").property("value");
    let unitPrice = d3.select("#unitPrice").property("value");
    var noActionProfit = 0;
    var individualProfit = 0;
    var groupProfit = 0;
    for (let x=1; x <= numYears; x++) {
      noActionProfit += annualYield * infectedYield(noaction(x*365,alpha,startingMonth)) * unitPrice;
      individualProfit += annualYield * infectedYield(individualspray(x*365,alpha,startingMonth)) * unitPrice
                              - sprayCost * numAcres;
      groupProfit += annualYield * infectedYield(groupspray(x*365,alpha,startingMonth)) * unitPrice
                              - sprayCost * numAcres;
      values.push({"x": x, "y": noActionProfit,"strategy": "No Action" });
      values.push({"x": x, "y": individualProfit, "strategy": "Individual Spray" });
      values.push({"x": x, "y": groupProfit, "strategy": "Coordinated Spray" });
    }

    //Group data
    var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
    //X-axis
    var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding])
    svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(5));
    //X-axis label
    svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-padding)
    .attr("y", height + 40)
    .text("Years since today");

    // Add Y axis
    var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height, 0 ]);
    svg.append("g")
    .call(d3.axisLeft(y));
    // Add Y-axis label
    svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", -50)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("Cumulative Profit");

    svg.append("text")
      .attr("x", ( (width - padding) / 2))             
      .attr("y", 0 - (margin.top / 2))
      .attr("class", "title")
      .attr("text-anchor", "middle")  
      .style("font-size", "20px") 
      .text("Cumulative Profit Over Next " + numYears + " Years");
    // color palette
    var res = sumstat.map(function(d){ return d.key }) // list of group names
    var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

    // Draw the line
    svg.selectAll(".line")
    .data(sumstat)
    .enter()
    .append("path")
      .attr("fill", "none")
      .attr("stroke", function(d){ return color(d.key) })
      .attr("stroke-width", 1.5)
      .attr("d", function(d){
        return d3.line()
          .x(function(d) { return x(d.x); })
          .y(function(d) { return y(+d.y); })
          (d.values)
      })
    svg.append("text")
    .attr("transform", "translate(" + ( (width - padding) +3) + "," + y(noaction(projectionLength, alpha, startingMonth)) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "red")
    .text("No Action");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(individualspray(projectionLength, alpha, startingMonth)) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "steelblue")
    .text("Individual Spraying");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(groupspray(projectionLength, alpha, startingMonth)) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "#4daf4a")
    .text("Coordinated Spraying");
  }

  function refreshOutput() {
    plotHLBSpread();
    plotYield();
    returnsPlot();
  }
  refreshOutput();
  d3.select("#inputs").selectAll("input").on("input change", refreshOutput);
  //Slideshow stuff
  var slideIndex = 1;
  showSlides(slideIndex);

  // Next/previous controls
  function plusSlides(n) {
    showSlides(slideIndex += n);
  }

  // Thumbnail image controls
  function currentSlide(n) {
    showSlides(slideIndex = n);
  }

  function showSlides(n) {
    var i;
    var slides = document.getElementsByClassName("mySlides");
    var dots = document.getElementsByClassName("dot");
    if (n > slides.length) {slideIndex = 1}
    if (n < 1) {slideIndex = slides.length}
    for (i = 0; i < slides.length; i++) {
        slides[i].style.display = "none";
    }
    for (i = 0; i < dots.length; i++) {
        dots[i].className = dots[i].className.replace(" active", "");
    }
    slides[slideIndex-1].style.display = "block";
    dots[slideIndex-1].className += " active";
  } 
  
  
  </script>

<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Load d3.js -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> 
<script src="https://d3js.org/d3.v4.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"> </script>-->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<style>
  
</style>

<!-- Create a div where the graph will take place -->
<h1>HLB Grower Web Tool</h1>
<p>
This is an unfinished, unstyled prototype of the HLB grower web tool. 
To use the tool, customize the options on the left and observe the output graphs. Mobile users are encouraged
to use landscape orientation for a better experience.
</p>
<div class="container">
  <div class="row">
    <div id="inputs" class="col-sm" >
      <label>Length of Simulation in Years</label>
      <br>
      <input type="number" id="projectionLength" min=1 max=40 value=5 />
      <br><br>
      <label>How many months until HLB arrives in your grove</label>
      <br>
      <input type="number" id="monthsToStart" min=0 max=480>
      <br><br>
      <label>% of Neighbors engaging in coordinated spraying</label>
      <br>
      <input type="range" min="0" max="100" value="50" class="slider" id="alpha">
      <br><br>
      <label>Cost of Spray per acre</label>
      <br>
      <input type="number" id="sprayCost" value=100>
      <br><br>
      <label>Number of Acres</label>
      <br>
      <input type="number" id="numAcres" value=55>
      <br><br>
      <label>Average Annual Yield (in cartons)</label>
      <br>
      <input type="number" id="annualYield" value="1000">
      <br><br>
      <label>Average Return per Carton (price of carton)</label>
      <br>
      <input type="number" id="unitPrice" value="14">
    </div>
    <div id="plotHolder" class="col-sm">
      <div id="hlbSpread"></div>
      <div id="yield"></div>
      <div id="profit"></div>
    </div>
  </div>
</div>
<!--
<div id="plotHolder">
  <div id="hlbSpread" class="mySlides fade"></div>
  <div id="yield" class="mySlides fade"></div>
  <div id="returns" class="mySlides fade"></div>
  <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
  <a class="next" onclick="plusSlides(1)">&#10095;</a>
  <div class="dotHolder">
    <span class="dot" onclick="currentSlide(1)"></span>
    <span class="dot" onclick="currentSlide(2)"></span>
    <span class="dot" onclick="currentSlide(3)"></span>
  </div>
</div>
-->
    
<script>
      //width = 700 - margin.left - margin.right,
      //height = 600 - margin.top - margin.bottom;

  function logCurve(B_0, g, K, t) {
    var numerator = K 
    var denom = 1+B_0*Math.exp(-1*g*t)
    return numerator / denom
  }
  //D3 and Plotting
  function noaction(x,alpha,startingMonth) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    // Log coefficients
    let B_0 = 43.9
    let g = 0.00465
    let K = 0.88395
    let B_0_alpha = 55.7
    let g_alpha = 0.00502
    let K_alpha = 0.88398

    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    let res = logCurve(B_0,g,K,scaledX)
    let alpha_res = logCurve(B_0_alpha,g_alpha,K_alpha,scaledX)
    
    return res + scaledAlpha*(alpha_res - res);
  }

  function individualspray(x,alpha,startingMonth) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    // Log coefficients
    let B_0 = 114
    let g = 0.00495
    let K = 0.86311
    let B_0_alpha = 192
    let g_alpha = 0.00565
    let K_alpha = 0.85544

    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    let res = logCurve(B_0,g,K,scaledX)
    let alpha_res = logCurve(B_0_alpha,g_alpha,K_alpha,scaledX)
    
    return res + scaledAlpha*(alpha_res - res);
  }

  function groupspray(x,alpha,startingMonth) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    // Log coefficients
    let B_0 = 115
    let g = 0.00493
    let K = 0.83849
    let B_0_alpha = 177
    let g_alpha = 0.00557
    let K_alpha = 0.83151

    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    let res = logCurve(B_0,g,K,scaledX)
    let alpha_res = logCurve(B_0_alpha,g_alpha,K_alpha,scaledX)
    
    return res + scaledAlpha*(alpha_res - res);
  }

  function infectedYield(severity) {
    return Math.exp(-1.85 * severity);
  }
  function plotHLBSpread(resize=false) { 
  //Remove any previous graphics
  let reDraw = d3.select("#hlbSpread").node().children.length > 0;
 
  // append the svg object to the body of the page
  //let height = d3.select("#plotHolder").node().getBoundingClientRect().height;
  let height = 500;
  
  var width = d3.select("#plotHolder").node().getBoundingClientRect().width;
  if (reDraw && !resize) {
    width = parseInt(d3.select("#hlbSpread_svg").attr("width"));
  }
  console.log(height)
  console.log(width)
  var margin = {top: Math.floor(0.095 * height), right: Math.floor(0.052*width), bottom: Math.floor(0.07*height), left: Math.floor(0.105*width)};
  console.log(margin)
  var padding = Math.floor(0.122 * width);
  //let height = container_height - margin.top - margin.bottom - padding;
  //let width = container_width - margin.left - margin.right - padding;
  var svg;
  if (d3.select("#hlbSpread").node().children.length == 0) {
    svg = d3.select("#hlbSpread")
    .append("svg")
      .attr("id", "hlbSpread_svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  } else {
    svg = d3.select("#hlbSpread_svg")
      .html("")
      .attr("id", "hlbSpread_svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  }
  
    
  
  var values = [];
  var startingMonth = d3.select("#monthsToStart").property("value");
  var numYears = d3.select("#projectionLength").property("value");
  var projectionLength = numYears * 365;
  var alpha = d3.select("#alpha").property("value");
  for (let x=1; x <= projectionLength; x++) {
    values.push({"x": x, "y": noaction(x,alpha, startingMonth),"strategy": "No Action" });
    values.push({"x": x, "y": individualspray(x,alpha,startingMonth), "strategy": "Individual Spray" });
    values.push({"x": x, "y": groupspray(x,alpha,startingMonth), "strategy": "Coordinated Spray" });
  }

  //Group data
  var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
  //X-axis
  var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding - margin.left - margin.right - padding])
  svg.append("g")
    .attr("transform", "translate(" + Math.floor(0.02 * width) + "," + (height - margin.top - padding) + ")")
    .call(d3.axisBottom(x).ticks(5));
  //X-axis label
  svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-margin.right-padding-padding)
    .attr("y", height-margin.top - Math.floor(1.2 * padding))
    .attr("font-size", "0.9rem")
    .text("Days since today");

  // Add Y axis
  var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height - margin.top - padding, 0 ]);
  svg.append("g")
    .attr("transform", "translate(" + Math.floor(0.02 * width) + ", 0)")
    .call(d3.axisLeft(y));
  // Add Y-axis label
  svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", Math.floor(0.4 * padding))
    .attr("dy", ".75em")
    .attr("font-size", "0.9em")
    .attr("transform", "rotate(-90)")
    .text("% of Grove infected with HLB");

  
  svg.append("text")
        .attr("x", (width - Math.floor(2 *padding)) /2)             
        .attr("y", 0 - (margin.top / 2))
        .attr("class", "title")
        .attr("text-anchor", "middle") 
        .attr("font-style", "italic") 
        .attr("font-weight", "bold")
        .style("font-size", "0.9em") 
        .text("Spread of HLB Over Next " + numYears + " Years");
  // color palette
  var res = sumstat.map(function(d){ return d.key }) // list of group names
  var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

  // Draw the line
  svg.selectAll(".line")
      .data(sumstat)
      .enter()
      .append("path")
        .attr("fill", "none")
        .attr("transform","translate(" + Math.floor(0.02 * width) + ", 0)")
        .attr("stroke", function(d){ return color(d.key) })
        .attr("stroke-width", 1.5)
        .attr("d", function(d){
          return d3.line()
            .x(function(d) { return x(d.x); })
            .y(function(d) { return y(+d.y); })
            (d.values)
        })
  svg.append("text")
		.attr("transform", "translate(" + ( (width - padding - padding - margin.right - margin.left + Math.floor(0.02 * width))) + "," + y(noaction(projectionLength, alpha, startingMonth)) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "red")
		.text("No Action");

	svg.append("text")
		.attr("transform", "translate(" + (width-padding - padding - margin.right - margin.left + Math.floor(0.02 * width)) + "," + y(individualspray(projectionLength, alpha, startingMonth)) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "steelblue")
		.text("Ind. Spray");
  
  svg.append("text")
		.attr("transform", "translate(" + (width-padding- padding - margin.right-margin.left + Math.floor(0.02 * width)) + "," + y(groupspray(projectionLength, alpha, startingMonth)) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "#4daf4a")
		.text("Coord. Spray");

  }
  function plotYield_v2(resize=false) { 
  //Remove any previous graphics
  let reDraw = d3.select("#yield").node().children.length > 0;
 
  // append the svg object to the body of the page
  //let height = d3.select("#plotHolder").node().getBoundingClientRect().height;
  let height = 500;
  
  var width = d3.select("#plotHolder").node().getBoundingClientRect().width;
  if (reDraw && !resize) {
    width = parseInt(d3.select("#yield_svg").attr("width"));
  }
  console.log(height)
  console.log(width)
  var margin = {top: Math.floor(0.095 * height), right: Math.floor(0.052*width), bottom: Math.floor(0.07*height), left: Math.floor(0.105*width)};
  console.log(margin)
  var padding = Math.floor(0.122 * width);
  //let height = container_height - margin.top - margin.bottom - padding;
  //let width = container_width - margin.left - margin.right - padding;
  var svg;
  if (d3.select("#yield").node().children.length == 0) {
    svg = d3.select("#yield")
    .append("svg")
      .attr("id", "yield_svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  } else {
    svg = d3.select("#yield_svg")
      .html("")
      .attr("id", "yield_svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  }
  
    
  
  var values = [];
  var startingMonth = d3.select("#monthsToStart").property("value");
  var numYears = d3.select("#projectionLength").property("value");
  var projectionLength = numYears * 365;
  var alpha = d3.select("#alpha").property("value");
  for (let x=1; x <= projectionLength; x++) {
    values.push({"x": x, "y": infectedYield(noaction(x,alpha, startingMonth)),"strategy": "No Action" });
    values.push({"x": x, "y": infectedYield(individualspray(x,alpha,startingMonth)), "strategy": "Individual Spray" });
    values.push({"x": x, "y": infectedYield(groupspray(x,alpha,startingMonth)), "strategy": "Coordinated Spray" });
  }

  //Group data
  var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
  //X-axis
  var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding - margin.left - margin.right - padding])
  svg.append("g")
    .attr("transform", "translate(" + Math.floor(0.02 * width) + "," + (height - margin.top - padding) + ")")
    .call(d3.axisBottom(x).ticks(5));
  //X-axis label
  svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-margin.right-padding-padding)
    .attr("y", height-margin.top - Math.floor(1.2 * padding))
    .attr("font-size", "0.9rem")
    .text("Days since today");

  // Add Y axis
  var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height - margin.top - padding, 0 ]);
  svg.append("g")
    .attr("transform", "translate(" + Math.floor(0.02 * width) + ", 0)")
    .call(d3.axisLeft(y));
  // Add Y-axis label
  svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", Math.floor(0.4 * padding))
    .attr("dy", ".75em")
    .attr("font-size", "0.9em")
    .attr("transform", "rotate(-90)")
    .text("Average Yield (% of Typical)");

  
  svg.append("text")
        .attr("x", (width - Math.floor(2 *padding)) /2)             
        .attr("y", 0 - (margin.top / 2))
        .attr("class", "title")
        .attr("text-anchor", "middle") 
        .attr("font-style", "italic") 
        .attr("font-weight", "bold")
        .style("font-size", "0.9em") 
        .text("Yield Over Next " + numYears + " Years");
  // color palette
  var res = sumstat.map(function(d){ return d.key }) // list of group names
  var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

  // Draw the line
  svg.selectAll(".line")
      .data(sumstat)
      .enter()
      .append("path")
        .attr("fill", "none")
        .attr("transform","translate(" + Math.floor(0.02 * width) + ", 0)")
        .attr("stroke", function(d){ return color(d.key) })
        .attr("stroke-width", 1.5)
        .attr("d", function(d){
          return d3.line()
            .x(function(d) { return x(d.x); })
            .y(function(d) { return y(+d.y); })
            (d.values)
        })
  svg.append("text")
		.attr("transform", "translate(" + ( (width - padding - padding - margin.right - margin.left + Math.floor(0.02 * width))) + "," + y(infectedYield(noaction(projectionLength, alpha, startingMonth))) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "red")
		.text("No Action");

	svg.append("text")
		.attr("transform", "translate(" + (width-padding - padding - margin.right - margin.left + Math.floor(0.02 * width)) + "," + y(infectedYield(individualspray(projectionLength, alpha, startingMonth))) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "steelblue")
		.text("Ind. Spray");
  
  svg.append("text")
		.attr("transform", "translate(" + (width-padding- padding - margin.right-margin.left + Math.floor(0.02 * width)) + "," + y(infectedYield(groupspray(projectionLength, alpha, startingMonth))) + ")")
		.attr("dy", ".35em")
		.attr("text-anchor", "start")
		.style("fill", "#4daf4a")
		.text("Coord. Spray");

  }
  
  function plotYield() {
    // set the dimensions and margins of the graph
    var margin = {top: 50, right: 30, bottom: 30, left: 60},
    width = 660 - margin.left - margin.right,
    padding = 60,
    height = 400 - margin.top - margin.bottom;
    //Remove any previous graphics
    d3.select("#yield").html("")
    // append the svg object to the body of the page
    var svg = d3.select("#yield")
    .append("svg")
    .attr("width", width + margin.left + margin.right + padding)
    .attr("height", height + margin.top + margin.bottom + padding + padding)
    .attr("id", "yield_svg")
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

    var values = [];
    var startingMonth = d3.select("#monthsToStart").property("value");
    var numYears = d3.select("#projectionLength").property("value");
    var projectionLength = numYears * 365;
    var alpha = d3.select("#alpha").property("value");
    for (let x=1; x <= projectionLength; x++) {
      values.push({"x": x, "y": infectedYield(noaction(x,alpha, startingMonth)),"strategy": "No Action" });
      values.push({"x": x, "y": infectedYield(individualspray(x,alpha,startingMonth)), "strategy": "Individual Spray" });
      values.push({"x": x, "y": infectedYield(groupspray(x,alpha,startingMonth)), "strategy": "Coordinated Spray" });
    }

    //Group data
    var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
    //X-axis
    var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding])
    svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(5));
    //X-axis label
    svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-padding)
    .attr("y", height + 40)
    .text("Days since today");

    // Add Y axis
    var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height, 0 ]);
    svg.append("g")
    .call(d3.axisLeft(y));
    // Add Y-axis label
    svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", -50)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("% of Regular Yield Level");

    svg.append("text")
      .attr("x", ( (width - padding) / 2))             
      .attr("y", 0 - (margin.top / 2))
      .attr("class", "title")
      .attr("text-anchor", "middle")  
      .style("font-size", "20px") 
      .text("Average Yield in Your Grove Over Next " + numYears + " Years");
    // color palette
    var res = sumstat.map(function(d){ return d.key }) // list of group names
    var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

    // Draw the line
    svg.selectAll(".line")
    .data(sumstat)
    .enter()
    .append("path")
      .attr("fill", "none")
      .attr("stroke", function(d){ return color(d.key) })
      .attr("stroke-width", 1.5)
      .attr("d", function(d){
        return d3.line()
          .x(function(d) { return x(d.x); })
          .y(function(d) { return y(+d.y); })
          (d.values)
      })
    svg.append("text")
    .attr("transform", "translate(" + ( (width - padding) +3) + "," + y(infectedYield(noaction(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "red")
    .text("No Action");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(infectedYield(individualspray(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "steelblue")
    .text("Individual Spraying");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(infectedYield(groupspray(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "#4daf4a")
    .text("Coordinated Spraying");

  }
  function plotProfit_v2(resize=false) { 
    //Remove any previous graphics
    let reDraw = d3.select("#profit").node().children.length > 0;
  
    // append the svg object to the body of the page
    //let height = d3.select("#plotHolder").node().getBoundingClientRect().height;
    let height = 500;
    
    var width = d3.select("#plotHolder").node().getBoundingClientRect().width;
    if (reDraw && !resize) {
      width = parseInt(d3.select("#profit_svg").attr("width"));
    }
    console.log(height)
    console.log(width)
    var margin = {top: Math.floor(0.095 * height), right: Math.floor(0.052*width), bottom: Math.floor(0.07*height), left: Math.floor(0.105*width)};
    console.log(margin)
    var padding = Math.floor(0.122 * width);
    //let height = container_height - margin.top - margin.bottom - padding;
    //let width = container_width - margin.left - margin.right - padding;
    var svg;
    if (d3.select("#profit").node().children.length == 0) {
      svg = d3.select("#profit")
      .append("svg")
        .attr("id", "profit_svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
    } else {
      svg = d3.select("#profit_svg")
        .html("")
        .attr("id", "profit_svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
    }
    
      
    
    var values = [];
    var startingMonth = d3.select("#monthsToStart").property("value");
    var numYears = d3.select("#projectionLength").property("value");
    let alpha = d3.select("#alpha").property("value");
    let sprayCost = d3.select("#sprayCost").property("value");
    let numAcres = d3.select("#numAcres").property("value");
    let annualYield = d3.select("#annualYield").property("value");
    let unitPrice = d3.select("#unitPrice").property("value");
    var noActionProfit = 0;
    var individualProfit = 0;
    var groupProfit = 0;
    for (let x=1; x <= numYears; x++) {
      noActionProfit += annualYield * infectedYield(noaction(x*365,alpha,startingMonth)) * unitPrice;
      individualProfit += annualYield * infectedYield(individualspray(x*365,alpha,startingMonth)) * unitPrice
                              - sprayCost * numAcres;
      groupProfit += annualYield * infectedYield(groupspray(x*365,alpha,startingMonth)) * unitPrice
                              - sprayCost * numAcres;
      values.push({"x": x, "y": noActionProfit,"strategy": "No Action" });
      values.push({"x": x, "y": individualProfit, "strategy": "Individual Spray" });
      values.push({"x": x, "y": groupProfit, "strategy": "Coordinated Spray" });
    }

    //Group data
    var sumstat = d3.nest()
      .key(function(d) { return d.strategy;})
      .entries(values);
    //X-axis
    var x = d3.scaleLinear()
      .domain(d3.extent(values, function(d) {return d.x; }))
      .range([0, width - padding - margin.left - margin.right - padding])
    svg.append("g")
      .attr("transform", "translate(" + Math.floor(0.02 * width) + "," + (height - margin.top - padding) + ")")
      .call(d3.axisBottom(x).ticks(5));
    //X-axis label
    svg.append("text")
      .attr("class", "x_label")
      .attr("text-anchor", "end")
      .attr("x", width-margin.right-padding-padding)
      .attr("y", height-margin.top - Math.floor(1.2 * padding))
      .attr("font-size", "0.9rem")
      .text("Days since today");

    // Add Y axis
    var y = d3.scaleLinear()
      .domain([0, d3.max(values, function(d) { return +d.y; })])
      .range([ height - margin.top - padding, 0 ]);
    svg.append("g")
      .attr("transform", "translate(" + Math.floor(0.02 * width) + ", 0)")
      .call(d3.axisLeft(y));
    // Add Y-axis label
    svg.append("text")
      .attr("class", "y_label")
      .attr("text-anchor", "end")
      .attr("y", Math.floor(0.4 * padding))
      .attr("dy", ".75em")
      .attr("font-size", "0.9em")
      .attr("transform", "rotate(-90)")
      .text("Cumulative Profit");

    
    svg.append("text")
          .attr("x", (width - Math.floor(2 *padding)) /2)             
          .attr("y", 0 - (margin.top / 2))
          .attr("class", "title")
          .attr("text-anchor", "middle") 
          .attr("font-style", "italic") 
          .attr("font-weight", "bold")
          .style("font-size", "0.9em") 
          .text("Cumulative Profit Over Next " + numYears + " Years");
    // color palette
    var res = sumstat.map(function(d){ return d.key }) // list of group names
    var color = d3.scaleOrdinal()
      .domain(res)
      .range(['#e41a1c','#377eb8','#4daf4a'])

    // Draw the line
    svg.selectAll(".line")
        .data(sumstat)
        .enter()
        .append("path")
          .attr("fill", "none")
          .attr("transform","translate(" + Math.floor(0.02 * width) + ", 0)")
          .attr("stroke", function(d){ return color(d.key) })
          .attr("stroke-width", 1.5)
          .attr("d", function(d){
            return d3.line()
              .x(function(d) { return x(d.x); })
              .y(function(d) { return y(+d.y); })
              (d.values)
          })
    svg.append("text")
      .attr("transform", "translate(" + ( (width - padding - padding - margin.right - margin.left + Math.floor(0.02 * width))) + "," + y(noActionProfit) + ")")
      .attr("dy", ".35em")
      .attr("text-anchor", "start")
      .style("fill", "red")
      .text("No Action");

    svg.append("text")
      .attr("transform", "translate(" + (width-padding - padding - margin.right - margin.left + Math.floor(0.02 * width)) + "," + y(individualProfit) + ")")
      .attr("dy", ".35em")
      .attr("text-anchor", "start")
      .style("fill", "steelblue")
      .text("Ind. Spray");
    
    svg.append("text")
      .attr("transform", "translate(" + (width-padding- padding - margin.right-margin.left + Math.floor(0.02 * width)) + "," + y(groupProfit) + ")")
      .attr("dy", ".35em")
      .attr("text-anchor", "start")
      .style("fill", "#4daf4a")
      .text("Coord. Spray");

  }
  function returnsPlot() {
    // set the dimensions and margins of the graph
    var margin = {top: 50, right: 30, bottom: 30, left: 60},
    width = 660 - margin.left - margin.right,
    padding = 60,
    height = 400 - margin.top - margin.bottom;
    //Remove any previous graphics
    d3.select("#returns").html("")
    // append the svg object to the body of the page
    var svg = d3.select("#returns")
    .append("svg")
    .attr("width", width + margin.left + margin.right + padding)
    .attr("height", height + margin.top + margin.bottom + padding + padding)
    .attr("id", "returns_svg")
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

    var values = [];
    var startingMonth = d3.select("#monthsToStart").property("value");
    var numYears = d3.select("#projectionLength").property("value");
    let alpha = d3.select("#alpha").property("value");
    let sprayCost = d3.select("#sprayCost").property("value");
    let numAcres = d3.select("#numAcres").property("value");
    let annualYield = d3.select("#annualYield").property("value");
    let unitPrice = d3.select("#unitPrice").property("value");
    var noActionProfit = 0;
    var individualProfit = 0;
    var groupProfit = 0;
    for (let x=1; x <= numYears; x++) {
      noActionProfit += annualYield * infectedYield(noaction(x*365,alpha,startingMonth)) * unitPrice;
      individualProfit += annualYield * infectedYield(individualspray(x*365,alpha,startingMonth)) * unitPrice
                              - sprayCost * numAcres;
      groupProfit += annualYield * infectedYield(groupspray(x*365,alpha,startingMonth)) * unitPrice
                              - sprayCost * numAcres;
      values.push({"x": x, "y": noActionProfit,"strategy": "No Action" });
      values.push({"x": x, "y": individualProfit, "strategy": "Individual Spray" });
      values.push({"x": x, "y": groupProfit, "strategy": "Coordinated Spray" });
    }

    //Group data
    var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
    //X-axis
    var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding])
    svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(5));
    //X-axis label
    svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-padding)
    .attr("y", height + 40)
    .text("Years since today");

    // Add Y axis
    var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height, 0 ]);
    svg.append("g")
    .call(d3.axisLeft(y));
    // Add Y-axis label
    svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", -50)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("Cumulative Profit");

    svg.append("text")
      .attr("x", ( (width - padding) / 2))             
      .attr("y", 0 - (margin.top / 2))
      .attr("class", "title")
      .attr("text-anchor", "middle")  
      .style("font-size", "20px") 
      .text("Cumulative Profit Over Next " + numYears + " Years");
    // color palette
    var res = sumstat.map(function(d){ return d.key }) // list of group names
    var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

    // Draw the line
    svg.selectAll(".line")
    .data(sumstat)
    .enter()
    .append("path")
      .attr("fill", "none")
      .attr("stroke", function(d){ return color(d.key) })
      .attr("stroke-width", 1.5)
      .attr("d", function(d){
        return d3.line()
          .x(function(d) { return x(d.x); })
          .y(function(d) { return y(+d.y); })
          (d.values)
      })
    svg.append("text")
    .attr("transform", "translate(" + ( (width - padding) +3) + "," + y(noActionProfit) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "red")
    .text("No Action");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(individualProfit) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "steelblue")
    .text("Individual Spraying");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(groupProfit) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "#4daf4a")
    .text("Coordinated Spraying");
  }

  function refreshOutput(resize=false) {
    plotHLBSpread(resize);
    plotYield_v2(resize);
    plotProfit_v2(resize);
  }
  refreshOutput();
  d3.select("#inputs").selectAll("input").on("input change", refreshOutput);
  d3.select(window).on('resize', function() { refreshOutput(true);} );
  for (var i = 0; i <= 1500; i += 500) {
    na_res_0 = noaction(i, 0, 0)
    na_res_1 = noaction(i, 1, 0)
    console.log(`(${i}, 0): ${na_res_0}`)
    console.log(`(${i}, 1): ${na_res_1}`)
  }
  //Slideshow stuff
  /*
  var slideIndex = 1;
  showSlides(slideIndex);

  // Next/previous controls
  function plusSlides(n) {
    showSlides(slideIndex += n);
  }

  // Thumbnail image controls
  function currentSlide(n) {
    showSlides(slideIndex = n);
  }

  function showSlides(n) {
    var i;
    var slides = document.getElementsByClassName("mySlides");
    var dots = document.getElementsByClassName("dot");
    if (n > slides.length) {slideIndex = 1}
    if (n < 1) {slideIndex = slides.length}
    for (i = 0; i < slides.length; i++) {
        slides[i].style.display = "none";
    }
    for (i = 0; i < dots.length; i++) {
        dots[i].className = dots[i].className.replace(" active", "");
    }
    slides[slideIndex-1].style.display = "block";
    dots[slideIndex-1].className += " active";
  } */
  
  
  </script>
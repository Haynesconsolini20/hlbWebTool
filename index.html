
<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Load d3.js -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> 
<script src="https://d3js.org/d3.v4.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"> </script>-->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<style>
html {
  margin: 5% 5% 5% 5%;
}
</style>

<!-- Create a div where the graph will take place -->
<h1>HLB Grower Web Tool</h1>

<h2>Background</h2>
Since the late 18th century, Huanglongbing (HLB) has devastated citrus production across 40 countries spanning Asia, Africa, and the Americas. It arrived in North America in 1998 when the Asian Citrus Psyllid (ACP), the insect that carries the disease, was first discovered in Florida. Within seven years, HLB was detected there as well, followed by a rapid spread of the disease, resulting in a $4.5 billion loss to the Florida economy by 2011 and decreased production by 8 million tons per year by 2020. In August 2020 CDFA announced discovery of the first infected psyllid in a commercial citrus grove in southern California, renewing concern about how best to handle the threat of HLB in California. This interactive site has been designed to assist in that discussion by providing growers with information on the potential economic consequences of different ACP spraying strategies.
<h2>How to use this tool</h2>
<p>Enter details for your grove below. The default values shown in the enter boxes are based on a recent <a href="https://coststudyfiles.ucdavis.edu/uploads/pub/2021/08/12/2021orangessjvsouth.pdf">University of California Cost and Returns Study</a>. Change them to fit your operation. Then select the percentage of neighbors who will particpate in coordinated spraying and the pesticide efficacy rate. Once the information is entered you will observe the output graphs change revealing a preferred psyllid mitigation strategy. The information here is based on the current reccomendations prescribed by the California Psyllid Management Areas (PMA). See the helpful links section for more information. Each graph has three colored lines: red for taking no action, blue for spraying in a 60-day window of your PMA prescribed dates, and green for spraying in a 21-day window of those dates. If you want a quick answer to the most profitable strategy, the first graph shows cumulative profit over the desired time period. The other two graphs show the percentage of the grove infected with HLB following initial infection and the effect of the spread on relative yields, respectively.</p>
<h2>More Information</h2>
<p>Funding to support the development of this tool provided by a CDFA grant (#19-0001-034-SF) and USDA-NFA ECDRE grant (#2017-70016-26053), and computing resources were provided by the IBM Power Systems Academic Initiative. For more information about the research that powers this tool, check out the research notes and publication in the links section or contact us at <a href="mailto:kaplanj@csus.edu">kaplanj@csus.edu</a>.</p>
<h3>Disclaimer</h3>
The insights generated from this tool are based on the simulated outcomes of representative California citrus growers. Many factors that influence a particular operation such as weather and geography could cause your results to differ from the information presented here. For personalized information about HLB and running an operation in your region, please consult your local extension agents and pest advisors.
<h3>Helpful Links</h3>
<p>
<a href="https://www.csus.edu/faculty/k/kaplanj/hlbtool/hlb_grower_web_tool_tech_note.pdf">Technical details of this tool</a><br/>
<a href="https://ucanr.edu/sites/ACP/Grower_Options/Grower_Management/Eradication_Strategies/">ACP Eradication Strategies</a><br/>
<a href="https://citrusinsider.org/psyllid-and-disease-control/treatments/treatment-schedules-by-region/">Treatment Schedules by Region</a><br/>
<a href="https://coststudyfiles.ucdavis.edu/uploads/pub/2021/08/12/2021orangessjvsouth.pdf">UC Extension Cost and Returns Study</a><br/>
<a href="https://www.csus.edu/faculty/k/kaplanj/researchnotes/research_note-2021_1_survey.pdf">Research Note 1 (Survey Results)</a><br/>
<a href="https://www.csus.edu/faculty/k/kaplanj/researchnotes/researchnote2021-2.pdf">Research Note 2 (Survival Analysis)</a><br/>
</p>
<div class="container">
  <div class="row">
    <div id="inputs" class="col-sm">
      <h1>Inputs</h1>
      <label>Length of Simulation in Years</label>
      <br>
      <input type="number" id="projectionLength" min=1 max=40 value=5 />
      <br><br>
      <label>How many months until HLB arrives in your grove</label>
      <br>
      <input type="number" id="monthsToStart" min=0 max=480 value=0>
      <br><br>
      <label>% of Neighbors engaging in coordinated spraying</label>
      <br>
      <input type="range" min="0" max="100" value="50" class="slider" id="alpha">
      <br><br>
      <label>Efficacy of insecticide used</label>
      <br>
      <input type="radio" id="e65" name="efficacy" value="65">
      <label>65%</label>
      <input type="radio" id="e75" name="efficacy" value="75">
      <label>75%</label>
      <input type="radio" id="e85" name="efficacy" value="85" checked>
      <label>85%</label>
      <br><br>
      <label>Cost of one insecticide application to one acre</label>
      <br>
      <input type="number" id="sprayCost" value="53.71">
      <br><br>
      <label>Number of acres</label>
      <br>
      <input type="number" id="numAcres" value=55>
      <br><br>
      <label>Average annual yield per acre (in 37.5lb cartons)</label>
      <br>
      <input type="number" id="annualYield" value="564">
      <br><br>
      <label>Average return per carton (price of carton)</label>
      <br>
      <input type="number" id="unitPrice" value="17.60">
      <br><br>
      <label>Annual fixed costs per acre</label>
      <br>
      <input type="number" id="annualCosts" value="9293">
    </div>
    <div id="plotHolder" class="col-sm">
      <h1>Output</h1>
      <div id="profit"></div>
      <div id="hlbSpread"></div>
      <div id="yield"></div>
    </div>
  </div>
</div>
<!--
<div id="plotHolder">
  <div id="hlbSpread" class="mySlides fade"></div>
  <div id="yield" class="mySlides fade"></div>
  <div id="returns" class="mySlides fade"></div>
  <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
  <a class="next" onclick="plusSlides(1)">&#10095;</a>
  <div class="dotHolder">
    <span class="dot" onclick="currentSlide(1)"></span>
    <span class="dot" onclick="currentSlide(2)"></span>
    <span class="dot" onclick="currentSlide(3)"></span>
  </div>
</div>
-->
    
<script>
  //Uncomment below for production
  console.log = function() {}
      //width = 700 - margin.left - margin.right,
      //height = 600 - margin.top - margin.bottom;
  function betaCurve(relT, efficacy, strategy, alpha) {
    // Coefficients
    var intercept = -2.44978330;
    var e75_coef = -0.20743718;
    var e85_coef = -0.07299259;
    var alpha1_coef = 0.01494436;
    var indv_coef = -0.15463509;
    var group_coef = -0.10212705;
    var maxT_coef = 0.00228886;
    var e75alpha1_coef = -0.06266322;
    var e85alpha1_coef = -0.79121443;
    var e75indv_coef = -0.16353347;
    var e85indv_coef = -0.64362937;
    var e75group_coef = -0.13874484;
    var e85group_coef = -0.85018937;
    var e75maxT_coef = 0.00018147;
    var e85maxT_coef = 0.00020873;
    var indvmaxT_coef = -0.00009667;
    var groupmaxT_coef = -0.00013745;
    var e75indvmaxT_coef = -0.00003253;
    var e85indvmaxT_coef = -0.00017724;
    var e75groupmaxT_coef = -0.00005853;
    var e85groupmaxT_coef = -0.00014676;
    
    //covariates
    var e75 = (efficacy == 0.75);
    var e85 = (efficacy == 0.85);
    var indv = (strategy == "Individual Action");
    var group = (strategy == "Group Action");

    //sum em up
    var sum_alpha1 = 0;
    var sum_alpha0 = 0;
    //sum the alpha0 case
    sum_alpha0 += intercept + 
                  (e75_coef * e75) + 
                  (e85_coef * e85) + 
                  (indv_coef * indv) + 
                  (group_coef * group) +
                  (maxT_coef * relT) + 
                  (e75indv_coef * (e75 * indv)) +
                  (e85indv_coef * (e85 * indv)) + 
                  (e75group_coef * (e75 * group)) +
                  (e85group_coef * (e85 * group)) +
                  (e75maxT_coef * (e75 * relT)) +
                  (e85maxT_coef * (e85 * relT)) +
                  (indvmaxT_coef * (indv * relT)) +
                  (groupmaxT_coef * (group * relT)) +
                  (e75indvmaxT_coef * (e75 * indv * relT)) +
                  (e85indvmaxT_coef * (e85 * indv * relT)) +
                  (e75groupmaxT_coef * (e75 * group * relT)) +
                  (e85groupmaxT_coef * (e85 * group * relT));
    // add the additional alpha terms
    sum_alpha1 = sum_alpha0 + 
                 alpha1_coef + 
                 (e75alpha1_coef * e75) +
                 (e85alpha1_coef * e85);
    //Take the weighted sum based on alpha
    var sum = sum_alpha0 + alpha*(sum_alpha1 - sum_alpha0);
    //Apply the logistic transformation 
    var transformed = 1 / (1 + Math.exp(-1*sum));
    return transformed;
  }

  function logCurve(B_0, g, K, t) {
    var numerator = K 
    var denom = 1+B_0*Math.exp(-1*g*t)
    return numerator / denom
  }
  //D3 and Plotting
  function noaction(x,alpha,startingMonth, efficacy) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    let beta = betaCurve(scaledX, efficacy, "No Action", scaledAlpha);
    return beta;
  }

  function individualspray(x,alpha,startingMonth, efficacy) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    return betaCurve(scaledX, efficacy, "Individual Action", scaledAlpha)
  }

  function groupspray(x,alpha,startingMonth, efficacy) {
    if (x < (startingMonth * 30)) {
      return 0;
    }
    var scaledX = x - (startingMonth * 30);
    var scaledAlpha = alpha / 100;
    return betaCurve(scaledX, efficacy, "Group Action", scaledAlpha);

  }

  function infectedYield(severity) {
    return Math.exp(-1.85 * severity);
  }
  function plotHLBSpread(resize=false) { 
  //Remove any previous graphics
  let reDraw = d3.select("#hlbSpread").node().children.length > 0;
 
  // append the svg object to the body of the page
  //let height = d3.select("#plotHolder").node().getBoundingClientRect().height;
  let height = 500;
  
  var width = d3.select("#plotHolder").node().getBoundingClientRect().width;
  if (reDraw && !resize) {
    width = parseInt(d3.select("#hlbSpread_svg").attr("width"));
  }
  console.log(height)
  console.log(width)
  var margin = {top: Math.floor(0.19 * height), right: Math.floor(0.052*width), bottom: Math.floor(0.07*height), left: Math.floor(0.105*width)};
  console.log(margin)
  var padding = Math.floor(0.122 * width);
  //let height = container_height - margin.top - margin.bottom - padding;
  //let width = container_width - margin.left - margin.right - padding;
  var svg;
  if (d3.select("#hlbSpread").node().children.length == 0) {
    svg = d3.select("#hlbSpread")
    .append("svg")
      .attr("id", "hlbSpread_svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  } else {
    svg = d3.select("#hlbSpread_svg")
      .html("")
      .attr("id", "hlbSpread_svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  }
  
    
  
  var values = [];
  var startingMonth = d3.select("#monthsToStart").property("value");
  var numYears = d3.select("#projectionLength").property("value");
  var projectionLength = numYears * 365;
  var alpha = d3.select("#alpha").property("value");
  var efficacy = d3.select('input[name="efficacy"]:checked').node().value
  efficacy = Number(efficacy) / 100;
  for (let x=1; x <= projectionLength; x++) {
    values.push({"x": x, "y": noaction(x,alpha, startingMonth, efficacy),"strategy": "No Action" });
    values.push({"x": x, "y": individualspray(x,alpha,startingMonth, efficacy), "strategy": "Individual Spray" });
    values.push({"x": x, "y": groupspray(x,alpha,startingMonth, efficacy), "strategy": "Coordinated Spray" });
  }

  //Group data
  var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
  //X-axis
  var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding - margin.left - margin.right - padding])
  svg.append("g")
    .attr("transform", "translate(" + Math.floor(0.02 * width) + "," + (height - margin.top - padding) + ")")
    .call(d3.axisBottom(x).ticks(5));
  //X-axis label
  svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-margin.right-padding-padding)
    .attr("y", height-margin.top - Math.floor(1.2 * padding))
    .attr("font-size", "0.9rem")
    .text("Days since today");

  // Add Y axis
  var formatPercent = d3.format(".0%")
  var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height - margin.top - padding, 0 ]);
  svg.append("g")
    .attr("transform", "translate(" + Math.floor(0.02 * width) + ", 0)")
    .call(d3.axisLeft(y).tickFormat(formatPercent));
  // Add Y-axis label
  svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", Math.floor(0.4 * padding))
    .attr("dy", ".75em")
    .attr("font-size", "0.9em")
    .attr("transform", "rotate(-90)")
    .text("% of Grove infected with HLB");

  
  svg.append("text")
        .attr("x", (width - Math.floor(2 *padding)) /2)             
        .attr("y", 0 - (margin.top / 2))
        .attr("class", "title")
        .attr("text-anchor", "middle") 
        .attr("font-style", "italic") 
        .attr("font-weight", "bold")
        .style("font-size", "0.9em") 
        .text("Spread of HLB Over Next " + numYears + " Years");
  // color palette
  var res = sumstat.map(function(d){ return d.key }) // list of group names
  var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

  // Draw the line
  svg.selectAll(".line")
      .data(sumstat)
      .enter()
      .append("path")
        .attr("fill", "none")
        .attr("transform","translate(" + Math.floor(0.02 * width) + ", 0)")
        .attr("stroke", function(d){ return color(d.key) })
        .attr("stroke-width", 1.5)
        .attr("d", function(d){
          return d3.line()
            .x(function(d) { return x(d.x); })
            .y(function(d) { return y(+d.y); })
            (d.values)
        })


  // ****************** LEGEND *********************
  legend_y = 0 - (margin.top / 4)
  noaction_x = (width - Math.floor(8 *padding)) /2
  //No Action
  svg.append("circle")
    .attr("cx",noaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "red");
  svg.append("text")
    .attr("x", noaction_x+10)
    .attr("y", legend_y+5)
    .text("None")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "red");
  //Indv Action
  indvaction_x = noaction_x+80
  svg.append("circle")
    .attr("cx",indvaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "steelblue");
  svg.append("text")
    .attr("x", indvaction_x+10)
    .attr("y", legend_y+5)
    .text("60-day")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "steelblue");
  //Group Action
  groupaction_x = indvaction_x+80
  svg.append("circle")
    .attr("cx",groupaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "#4daf4a");
  svg.append("text")
    .attr("x", groupaction_x+10)
    .attr("y", legend_y+5)
    .text("21-day")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "#4daf4a");

  }
  function plotYield_v2(resize=false) { 
  //Remove any previous graphics
  let reDraw = d3.select("#yield").node().children.length > 0;
 
  // append the svg object to the body of the page
  //let height = d3.select("#plotHolder").node().getBoundingClientRect().height;
  let height = 500;
  
  var width = d3.select("#plotHolder").node().getBoundingClientRect().width;
  if (reDraw && !resize) {
    width = parseInt(d3.select("#yield_svg").attr("width"));
  }
  console.log(height)
  console.log(width)
  var margin = {top: Math.floor(0.19 * height), right: Math.floor(0.052*width), bottom: Math.floor(0.07*height), left: Math.floor(0.105*width)};
  console.log(margin)
  var padding = Math.floor(0.122 * width);
  //let height = container_height - margin.top - margin.bottom - padding;
  //let width = container_width - margin.left - margin.right - padding;
  var svg;
  if (d3.select("#yield").node().children.length == 0) {
    svg = d3.select("#yield")
    .append("svg")
      .attr("id", "yield_svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  } else {
    svg = d3.select("#yield_svg")
      .html("")
      .attr("id", "yield_svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  }
  
    
  
  var values = [];
  var startingMonth = d3.select("#monthsToStart").property("value");
  var numYears = d3.select("#projectionLength").property("value");
  var projectionLength = numYears * 365;
  var alpha = d3.select("#alpha").property("value");
  var efficacy = d3.select('input[name="efficacy"]:checked').node().value
  efficacy = Number(efficacy) / 100;
  for (let x=1; x <= projectionLength; x++) {
    values.push({"x": x, "y": infectedYield(noaction(x,alpha, startingMonth, efficacy)),"strategy": "No Action" });
    values.push({"x": x, "y": infectedYield(individualspray(x,alpha,startingMonth, efficacy)), "strategy": "Individual Spray" });
    values.push({"x": x, "y": infectedYield(groupspray(x,alpha,startingMonth, efficacy)), "strategy": "Coordinated Spray" });
  }

  //Group data
  var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
  //X-axis
  var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding - margin.left - margin.right - padding])
  svg.append("g")
    .attr("transform", "translate(" + Math.floor(0.02 * width) + "," + (height - margin.top - padding) + ")")
    .call(d3.axisBottom(x).ticks(5));
  //X-axis label
  svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-margin.right-padding-padding)
    .attr("y", height-margin.top - Math.floor(1.2 * padding))
    .attr("font-size", "0.9rem")
    .text("Days since today");

  // Add Y axis
  var formatPercent = d3.format(".0%")
  var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height - margin.top - padding, 0 ]);
  svg.append("g")
    .attr("transform", "translate(" + Math.floor(0.02 * width) + ", 0)")
    .call(d3.axisLeft(y).tickFormat(formatPercent));
  // Add Y-axis label
  svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", Math.floor(0.4 * padding))
    .attr("dy", ".75em")
    .attr("font-size", "0.9em")
    .attr("transform", "rotate(-90)")
    .text("Average Yield (% of Typical)");

  
  svg.append("text")
        .attr("x", (width - Math.floor(2 *padding)) /2)             
        .attr("y", 0 - (margin.top / 2))
        .attr("class", "title")
        .attr("text-anchor", "middle") 
        .attr("font-style", "italic") 
        .attr("font-weight", "bold")
        .style("font-size", "0.9em") 
        .text("Yield Over Next " + numYears + " Years");
  // color palette
  var res = sumstat.map(function(d){ return d.key }) // list of group names
  var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

  // Draw the line
  svg.selectAll(".line")
      .data(sumstat)
      .enter()
      .append("path")
        .attr("fill", "none")
        .attr("transform","translate(" + Math.floor(0.02 * width) + ", 0)")
        .attr("stroke", function(d){ return color(d.key) })
        .attr("stroke-width", 1.5)
        .attr("d", function(d){
          return d3.line()
            .x(function(d) { return x(d.x); })
            .y(function(d) { return y(+d.y); })
            (d.values)
        })
   // ****************** LEGEND *********************
   legend_y = 0 - (margin.top / 4)
  noaction_x = (width - Math.floor(8 *padding)) /2
  //No Action
  svg.append("circle")
    .attr("cx",noaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "red");
  svg.append("text")
    .attr("x", noaction_x+10)
    .attr("y", legend_y+5)
    .text("None")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "red");
  //Indv Action
  indvaction_x = noaction_x+80
  svg.append("circle")
    .attr("cx",indvaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "steelblue");
  svg.append("text")
    .attr("x", indvaction_x+10)
    .attr("y", legend_y+5)
    .text("60-day")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "steelblue");
  //Group Action
  groupaction_x = indvaction_x+80
  svg.append("circle")
    .attr("cx",groupaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "#4daf4a");
  svg.append("text")
    .attr("x", groupaction_x+10)
    .attr("y", legend_y+5)
    .text("21-day")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "#4daf4a");


  }
  
  function plotYield() {
    // set the dimensions and margins of the graph
    var margin = {top: 50, right: 30, bottom: 30, left: 60},
    width = 660 - margin.left - margin.right,
    padding = 60,
    height = 400 - margin.top - margin.bottom;
    //Remove any previous graphics
    d3.select("#yield").html("")
    // append the svg object to the body of the page
    var svg = d3.select("#yield")
    .append("svg")
    .attr("width", width + margin.left + margin.right + padding)
    .attr("height", height + margin.top + margin.bottom + padding + padding)
    .attr("id", "yield_svg")
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

    var values = [];
    var startingMonth = d3.select("#monthsToStart").property("value");
    var numYears = d3.select("#projectionLength").property("value");
    var projectionLength = numYears * 365;
    var alpha = d3.select("#alpha").property("value");
    for (let x=1; x <= projectionLength; x++) {
      values.push({"x": x, "y": infectedYield(noaction(x,alpha, startingMonth)),"strategy": "No Action" });
      values.push({"x": x, "y": infectedYield(individualspray(x,alpha,startingMonth)), "strategy": "Individual Spray" });
      values.push({"x": x, "y": infectedYield(groupspray(x,alpha,startingMonth)), "strategy": "Coordinated Spray" });
    }

    //Group data
    var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
    //X-axis
    var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding])
    svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(5));
    //X-axis label
    svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-padding)
    .attr("y", height + 40)
    .text("Days since today");

    // Add Y axis
    var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height, 0 ]);
    svg.append("g")
    .call(d3.axisLeft(y));
    // Add Y-axis label
    svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", -50)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("% of Regular Yield Level");

    svg.append("text")
      .attr("x", ( (width - padding) / 2))             
      .attr("y", 0 - (margin.top / 2))
      .attr("class", "title")
      .attr("text-anchor", "middle")  
      .style("font-size", "20px") 
      .text("Average Yield in Your Grove Over Next " + numYears + " Years");
    // color palette
    var res = sumstat.map(function(d){ return d.key }) // list of group names
    var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

    // Draw the line
    svg.selectAll(".line")
    .data(sumstat)
    .enter()
    .append("path")
      .attr("fill", "none")
      .attr("stroke", function(d){ return color(d.key) })
      .attr("stroke-width", 1.5)
      .attr("d", function(d){
        return d3.line()
          .x(function(d) { return x(d.x); })
          .y(function(d) { return y(+d.y); })
          (d.values)
      })
    svg.append("text")
    .attr("transform", "translate(" + ( (width - padding) +3) + "," + y(infectedYield(noaction(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "red")
    .text("No Action");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(infectedYield(individualspray(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "steelblue")
    .text("Individual Spraying");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(infectedYield(groupspray(projectionLength, alpha, startingMonth))) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "#4daf4a")
    .text("Coordinated Spraying");

  }
  function plotProfit_v2(resize=false) { 
    //Remove any previous graphics
    let reDraw = d3.select("#profit").node().children.length > 0;
  
    // append the svg object to the body of the page
    //let height = d3.select("#plotHolder").node().getBoundingClientRect().height;
    let height = 500;
    
    var width = d3.select("#plotHolder").node().getBoundingClientRect().width;
    if (reDraw && !resize) {
      width = parseInt(d3.select("#profit_svg").attr("width"));
    }
    console.log(height)
    console.log(width)
    var margin = {top: Math.floor(0.19 * height), right: Math.floor(0.052*width), bottom: Math.floor(0.07*height), left: Math.floor(0.105*width)};
    console.log(margin)
    var padding = Math.floor(0.122 * width);
    //let height = container_height - margin.top - margin.bottom - padding;
    //let width = container_width - margin.left - margin.right - padding;
    var svg;
    if (d3.select("#profit").node().children.length == 0) {
      svg = d3.select("#profit")
      .append("svg")
        .attr("id", "profit_svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
    } else {
      svg = d3.select("#profit_svg")
        .html("")
        .attr("id", "profit_svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
    }
    
      
    
    var values = [];
    var startingMonth = d3.select("#monthsToStart").property("value");
    var numYears = d3.select("#projectionLength").property("value");
    let alpha = d3.select("#alpha").property("value");
    var efficacy = d3.select('input[name="efficacy"]:checked').node().value
    efficacy = Number(efficacy) / 100;
    let sprayCost = d3.select("#sprayCost").property("value");
    let numAcres = d3.select("#numAcres").property("value");
    let annualYield = d3.select("#annualYield").property("value");
    let unitPrice = d3.select("#unitPrice").property("value");
    let annualCosts = d3.select("#annualCosts").property("value");
    var noActionProfit = 0;
    var individualProfit = 0;
    var groupProfit = 0;
    for (let x=0; x <= numYears; x++) {
      noActionProfit += annualYield * infectedYield(noaction(x*365,alpha,startingMonth,efficacy)) * unitPrice * numAcres - (numAcres*annualCosts);
      individualProfit += annualYield * infectedYield(individualspray(x*365,alpha,startingMonth,efficacy)) * unitPrice * numAcres
                              - (sprayCost * numAcres * 6) - (numAcres*annualCosts);
      groupProfit += annualYield * infectedYield(groupspray(x*365,alpha,startingMonth,efficacy)) * unitPrice * numAcres
                              - (sprayCost * numAcres * 6) - (numAcres*annualCosts);
      values.push({"x": x, "y": noActionProfit,"strategy": "No Action" });
      values.push({"x": x, "y": individualProfit, "strategy": "Individual Spray" });
      values.push({"x": x, "y": groupProfit, "strategy": "Coordinated Spray" });
    }

    //Group data
    var sumstat = d3.nest()
      .key(function(d) { return d.strategy;})
      .entries(values);
    //X-axis
    var x = d3.scaleLinear()
      .domain(d3.extent(values, function(d) {return d.x; }))
      .range([0, width - padding - margin.left - margin.right - padding])
    svg.append("g")
      .attr("transform", "translate(" + Math.floor(0.02 * width) + "," + (height - margin.top - padding) + ")")
      .call(d3.axisBottom(x).ticks(5));
    //X-axis label
    svg.append("text")
      .attr("class", "x_label")
      .attr("text-anchor", "end")
      .attr("x", width-margin.right-padding-padding)
      .attr("y", height-margin.top - Math.floor(1.2 * padding))
      .attr("font-size", "0.9rem")
      .text("Years since today");

    // Add Y axis
    // OLD AXIS DOMAIN .domain([0, d3.max(values, function(d) { return +d.y; })])
    var y_domain = d3.extent(values, function(d) {return d.y; });
    console.log(y_domain)
    var y_d_range = Math.abs(y_domain[1] - y_domain[0])
    y_domain[0] = y_domain[0] - (y_d_range * 0.1)
    y_domain[1] = y_domain[1] + (y_d_range * 0.1)
    console.log(y_domain)
    var y = d3.scaleLinear()
      .domain(y_domain)
      .range([ height - margin.top - padding, 0 ]);
    svg.append("g")
      .attr("transform", "translate(" + Math.floor(0.02 * width) + ", 0)")
      .call(d3.axisLeft(y));
    // Add Y-axis label
    svg.append("text")
      .attr("class", "y_label")
      .attr("text-anchor", "end")
      .attr("y", Math.floor(0.4 * padding))
      .attr("dy", ".75em")
      .attr("font-size", "0.9em")
      .attr("transform", "rotate(-90)")
      .text("Cumulative Profit");

    
    svg.append("text")
          .attr("x", (width - Math.floor(2 *padding)) /2)             
          .attr("y", 0 - (margin.top / 2))
          .attr("class", "title")
          .attr("text-anchor", "middle") 
          .attr("font-style", "italic") 
          .attr("font-weight", "bold")
          .style("font-size", "0.9em") 
          .text("Cumulative Profit Over Next " + numYears + " Years");
    // color palette
    var res = sumstat.map(function(d){ return d.key }) // list of group names
    var color = d3.scaleOrdinal()
      .domain(res)
      .range(['#e41a1c','#377eb8','#4daf4a'])

    // Draw the line
    svg.selectAll(".line")
        .data(sumstat)
        .enter()
        .append("path")
          .attr("fill", "none")
          .attr("transform","translate(" + Math.floor(0.02 * width) + ", 0)")
          .attr("stroke", function(d){ return color(d.key) })
          .attr("stroke-width", 1.5)
          .attr("d", function(d){
            return d3.line()
              .x(function(d) { return x(d.x); })
              .y(function(d) { return y(+d.y); })
              (d.values)
          })
    // ****************** LEGEND *********************
  legend_y = 0 - (margin.top / 4)
  noaction_x = (width - Math.floor(8 *padding)) /2
  //No Action
  svg.append("circle")
    .attr("cx",noaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "red");
  svg.append("text")
    .attr("x", noaction_x+10)
    .attr("y", legend_y+5)
    .text("None")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "red");
  //Indv Action
  indvaction_x = noaction_x+80
  svg.append("circle")
    .attr("cx",indvaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "steelblue");
  svg.append("text")
    .attr("x", indvaction_x+10)
    .attr("y", legend_y+5)
    .text("60-day")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "steelblue");
  //Group Action
  groupaction_x = indvaction_x+80
  svg.append("circle")
    .attr("cx",groupaction_x)
    .attr("cy",legend_y)
    .attr("r", 6)
    .style("fill", "#4daf4a");
  svg.append("text")
    .attr("x", groupaction_x+10)
    .attr("y", legend_y+5)
    .text("21-day")
    .style("font-size", "15px")
    .attr("alignment-baseline","middle")
    .attr("fill", "#4daf4a");


  }
  function returnsPlot() {
    // set the dimensions and margins of the graph
    var margin = {top: 50, right: 30, bottom: 30, left: 60},
    width = 660 - margin.left - margin.right,
    padding = 60,
    height = 400 - margin.top - margin.bottom;
    //Remove any previous graphics
    d3.select("#returns").html("")
    // append the svg object to the body of the page
    var svg = d3.select("#returns")
    .append("svg")
    .attr("width", width + margin.left + margin.right + padding)
    .attr("height", height + margin.top + margin.bottom + padding + padding)
    .attr("id", "returns_svg")
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

    var values = [];
    var startingMonth = d3.select("#monthsToStart").property("value");
    var numYears = d3.select("#projectionLength").property("value");
    let alpha = d3.select("#alpha").property("value");
    let sprayCost = d3.select("#sprayCost").property("value");
    let numAcres = d3.select("#numAcres").property("value");
    let annualYield = d3.select("#annualYield").property("value");
    let unitPrice = d3.select("#unitPrice").property("value");
    var noActionProfit = 0;
    var individualProfit = 0;
    var groupProfit = 0;
    for (let x=1; x <= numYears; x++) {
      noActionProfit += annualYield * infectedYield(noaction(x*365,alpha,startingMonth)) * unitPrice;
      individualProfit += annualYield * infectedYield(individualspray(x*365,alpha,startingMonth)) * unitPrice
                              - sprayCost * numAcres;
      groupProfit += annualYield * infectedYield(groupspray(x*365,alpha,startingMonth)) * unitPrice
                              - sprayCost * numAcres;
      values.push({"x": x, "y": noActionProfit,"strategy": "No Action" });
      values.push({"x": x, "y": individualProfit, "strategy": "Individual Spray" });
      values.push({"x": x, "y": groupProfit, "strategy": "Coordinated Spray" });
    }

    //Group data
    var sumstat = d3.nest()
    .key(function(d) { return d.strategy;})
    .entries(values);
    //X-axis
    var x = d3.scaleLinear()
    .domain(d3.extent(values, function(d) {return d.x; }))
    .range([0, width - padding])
    svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).ticks(5));
    //X-axis label
    svg.append("text")
    .attr("class", "x_label")
    .attr("text-anchor", "end")
    .attr("x", width-padding)
    .attr("y", height + 40)
    .text("Years since today");

    // Add Y axis
    var y = d3.scaleLinear()
    .domain([0, d3.max(values, function(d) { return +d.y; })])
    .range([ height, 0 ]);
    svg.append("g")
    .call(d3.axisLeft(y));
    // Add Y-axis label
    svg.append("text")
    .attr("class", "y_label")
    .attr("text-anchor", "end")
    .attr("y", -50)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("Cumulative Profit");

    svg.append("text")
      .attr("x", ( (width - padding) / 2))             
      .attr("y", 0 - (margin.top / 2))
      .attr("class", "title")
      .attr("text-anchor", "middle")  
      .style("font-size", "20px") 
      .text("Cumulative Profit Over Next " + numYears + " Years");
    // color palette
    var res = sumstat.map(function(d){ return d.key }) // list of group names
    var color = d3.scaleOrdinal()
    .domain(res)
    .range(['#e41a1c','#377eb8','#4daf4a'])

    // Draw the line
    svg.selectAll(".line")
    .data(sumstat)
    .enter()
    .append("path")
      .attr("fill", "none")
      .attr("stroke", function(d){ return color(d.key) })
      .attr("stroke-width", 1.5)
      .attr("d", function(d){
        return d3.line()
          .x(function(d) { return x(d.x); })
          .y(function(d) { return y(+d.y); })
          (d.values)
      })
    svg.append("text")
    .attr("transform", "translate(" + ( (width - padding) +3) + "," + y(noActionProfit) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "red")
    .text("No Action");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(individualProfit) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "steelblue")
    .text("Individual Spraying");

    svg.append("text")
    .attr("transform", "translate(" + (width-padding+3) + "," + y(groupProfit) + ")")
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .style("fill", "#4daf4a")
    .text("Coordinated Spraying");
  }

  function refreshOutput(resize=false) {
    plotHLBSpread(resize);
    plotYield_v2(resize);
    plotProfit_v2(resize);
  }
  refreshOutput();
  d3.select("#inputs").selectAll("input").on("input change", refreshOutput);
  d3.select(window).on('resize', function() { refreshOutput(true);} );
  for (var i = 0; i <= 1500; i += 500) {
    na_res_0 = noaction(i, 0, 0)
    na_res_1 = noaction(i, 1, 0)
    console.log(`(${i}, 0): ${na_res_0}`)
    console.log(`(${i}, 1): ${na_res_1}`)
  }
  //Slideshow stuff
  /*
  var slideIndex = 1;
  showSlides(slideIndex);

  // Next/previous controls
  function plusSlides(n) {
    showSlides(slideIndex += n);
  }

  // Thumbnail image controls
  function currentSlide(n) {
    showSlides(slideIndex = n);
  }

  function showSlides(n) {
    var i;
    var slides = document.getElementsByClassName("mySlides");
    var dots = document.getElementsByClassName("dot");
    if (n > slides.length) {slideIndex = 1}
    if (n < 1) {slideIndex = slides.length}
    for (i = 0; i < slides.length; i++) {
        slides[i].style.display = "none";
    }
    for (i = 0; i < dots.length; i++) {
        dots[i].className = dots[i].className.replace(" active", "");
    }
    slides[slideIndex-1].style.display = "block";
    dots[slideIndex-1].className += " active";
  } */
  
  
  </script>